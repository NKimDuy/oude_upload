<!DOCTYPE html>
<html>
<head>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="FileSaver.js/dist/FileSaver.js"></script>
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js" ></script>
<script lang="javascript" src="./sheetjs/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
<script>
	
</script>
</head>
<body>
<div id="navbar"><span>Red Stapler - SheetJS </span></div>
<div id="wrapper">
        
        <input type="file" id="input-excel" />
</div>
<button id="btnAdd">click</button>


<script>
	function addslashes(str) { // có nhiệm vụ hiểu dấu nháy đơn trong chuỗi
		return (str + '').replace(/[\\"']/g, '\\$&').replace(/\u0000/g, '\\0');
	}

	function checkAll() { // chọn hoặc bỏ chọn tất cả các checkbox
		if($("#chkAll").is(':checked')) {
			$("#wrapper table input:checkbox:not(#chkAll)").prop("checked","checked");
		}
		else {
			$("#wrapper table input:checkbox:not(#chkAll)").prop("checked",false);
		}
	}

	$(document).ready(function() {
		
		
		var title = []; // lưu thông tin tiêu đề các cột
		var record = ""; // lưu thông tin các record
		var wb = null; // lưu giữ thông tin workbook nào đang được tương tác
		var sheetName = null; // lấy worksheet tương ứng với workbook
        var range = null; // lấy tất cả các ô có giá trị trong sheet
		$('#input-excel').change(function(e){
			var reader = new FileReader();
			reader.readAsArrayBuffer(e.target.files[0]);
			reader.onload = function(e) {
				var data = new Uint8Array(reader.result);
				wb = XLSX.read(data,{type:'array'}); // tạo ra workbook từ dataReader vừa load file lên
				
				var htmlstr = XLSX.write(wb,{sheet:"Sheet1", type:'string', bookType:'html'});
				
				$('#wrapper')[0].innerHTML += htmlstr;
				$("#wrapper table tr:first-child").prepend("<td><input id='chkAll' type='checkbox'  onclick='checkAll()' /></td>");
				$("#wrapper table tr").not("tr:first-child").prepend("<td><input type='checkbox' /></td>");
				//$("#wrapper table tr").prepend("<td><input type='checkbox' /></td>");
				// lấy giá trị các ô trong excel
				sheetName = wb.Sheets["Sheet1"]; // lấy sheet có tên là Sheet1
			
				range = XLSX.utils.decode_range(sheetName['!ref']); // !ref có ý nghĩa là chỉ chọn vùng nào có tồn tại dữ liệu
				
				var R = 0; // // chỉ mục của dòng đầu tiên để lấy các tiêu đề cột
				for(var C = range.s.c; C <= range.e.c; ++C) {
					var cell_address = {c:C, r:R};
					var cell_ref = XLSX.utils.encode_cell(cell_address);
					var desired_cell = sheetName[cell_ref];
					title.push(desired_cell.v);
				}
				
				
				// gán ID đến các checkbox tương ứng, bắt đầu là 1
				var input_index = range.s.r + 1;
				$("#wrapper table input:checkbox").each(function(index, item) {
					if (index != 0) {
						$(item).attr("id",input_index++);
					}
					
				});				
			}
			
        });
		
		$('#btnAdd').click(() => {
			var msg = "";
			var rows = "";
			$("#wrapper table input:checked:not(#chkAll)").each(function(index, item) {
					
					var R = $(item).attr("id"); // lấy dòng tương ứng với ID của checkbox
					
					var value_temp = [];
					try {
						for(var C = range.s.c; C <= range.e.c; ++C) {
							var cell_address = {c:C, r:parseInt(R)};
							var cell_ref = XLSX.utils.encode_cell(cell_address);
							
							var desired_cell = sheetName[cell_ref];
							if (desired_cell === undefined)
								desired_cell = "";
							//if (desired_cell.v === undefined) {
								//msg += desired_cell.v + ' ';
							//	var blob = new Blob([cell_ref],
							//	{ type: "text/plain;charset=utf-8" });
							//	saveAs(blob, "static.txt");
							//}
							//msg += desired_cell.v;
							value_temp.push(addslashes(desired_cell.v));
							//alert(desired_cell.v);
						}
					}
					catch(e) {
						console.log(e.message);
						
					}
					
					
					$.post({
						url:"./CreateTableAjax.php",
						data: {
							"title": title,
							"data": value_temp
						},
						dataType: "json"
					}).done((result) => {
						
					});
					
			});
			
		});
		
		
	});
</script>
</body>
</html>